<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ANT61 Work Log (Google Calendar API)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="light dark">
<style>
  :root{--bg:#0b0c10;--card:#12141a;--muted:#8892a6;--text:#e6eaf2;--border:#232838;--accent:#1a5fff;--pill:#0e1322}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:24px 16px;text-align:center;background:#0f1118;border-bottom:1px solid var(--border)}
  .title{font-weight:900;font-size:20px} .stats{font-size:32px;font-weight:900;margin-top:8px} .sub{color:var(--muted)}
  .wrap{max-width:900px;margin:22px auto;padding:0 16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  h2{margin:0 0 10px 0;font-size:16px} .list{display:grid;gap:8px}
  .row{display:flex;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--pill)}
  .when{font-weight:700} .meta{color:var(--muted);font-size:12px} .empty{color:var(--muted);font-style:italic}
  .chips{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
  .chip{border:1px solid var(--border);background:#0f1424;color:#cfe3ff;padding:6px 10px;border-radius:999px;font-weight:700}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{appearance:none;border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
  button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .err{background:#2a0f14;border:1px solid #5b1f2a;color:#ffd6db;padding:10px;border-radius:10px}
  footer{opacity:.7;text-align:center;margin:18px 0 10px}
</style>
</head>
<body>
<header>
  <div class="title">ANT61 Work Log</div>
  <div class="stats" id="totalHours">Loading…</div>
  <div class="sub" id="totalDays"></div>
  <div class="chips">
    <span class="chip">Events named: <b>work</b></span>
    <span class="chip">Timezone: Australia/Sydney</span>
  </div>
</header>

<div class="wrap">
  <div id="error" class="err" style="display:none"></div>

  <div class="card">
    <h2>Past sessions (newest → oldest)</h2>
    <div class="list" id="past"><div class="empty">Fetching…</div></div>
  </div>

  <div class="card">
    <h2>Next 3 sessions</h2>
    <div class="list" id="next"><div class="empty">Fetching…</div></div>
    <div class="actions" style="margin-top:10px">
      <button class="ghost" id="toggleFuture" disabled>Show all future sessions</button>
    </div>
  </div>

  <div class="card" id="futureCard" style="display:none">
    <h2>All future sessions</h2>
    <div class="list" id="future"><div class="empty">No future sessions.</div></div>
  </div>
</div>

<footer>Public Google Calendar API (no login). If nothing appears, check API key & calendar is public.</footer>

<script>
/* ====== CONFIG ====== */
const API_KEY = "AIzaSyARyKqEYg8ImmnLVwXKCWAJatSN2RROlwQ"; // Enable "Google Calendar API" in Google Cloud. Restrict HTTP referrers to your GitHub Pages URL.
const CAL_ID  = "aff5e1c22d61a3b0995590917f322322f031f87485955b05af7b8160db0f5370@group.calendar.google.com"; // your public ANT61 calendar
const TIMEZONE = "Australia/Sydney";

/* ====== Formatting ====== */
const fmtDate = new Intl.DateTimeFormat("en-AU", { timeZone: TIMEZONE, weekday:"short", day:"2-digit", month:"short", year:"numeric" });
const fmtTime = new Intl.DateTimeFormat("en-AU", { timeZone: TIMEZONE, hour:"2-digit", minute:"2-digit", hour12:false });

/* ====== Helpers ====== */
const isWork = ev => (ev.summary||"").trim().toLowerCase() === "work";
const evStart = ev => ev.start?.dateTime ? new Date(ev.start.dateTime) : (ev.start?.date ? new Date(ev.start.date) : null);
const evEnd   = ev => ev.end?.dateTime   ? new Date(ev.end.dateTime)   : (ev.end?.date   ? new Date(ev.end.date)   : null);
function durHours(ev){ const s=evStart(ev), e=evEnd(ev); if(!s||!e) return 0; if(ev.start?.date||ev.end?.date) return 0; return (e-s)/36e5; }
function line(ev){
  const s=evStart(ev), e=evEnd(ev);
  if(!s||!e) return `<span class="when">Working</span> <span class="meta">time missing</span>`;
  if(ev.start?.date||ev.end?.date) return `<span class="when">Working</span> <span class="meta">All-day · ${fmtDate.format(s)}</span>`;
  return `<span class="when">Working</span> <span class="meta">${fmtTime.format(s)} → ${fmtTime.format(e)} · ${fmtDate.format(s)}</span>`;
}
function setText(id, t){ document.getElementById(id).textContent=t; }
function setError(msg){ const el=document.getElementById("error"); el.style.display="block"; el.textContent=msg; }

/* ====== Google Calendar API fetch with pagination ====== */
async function fetchAll(params){
  let items=[], pageToken;
  do{
    const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CAL_ID)}/events`);
    const q = new URLSearchParams({
      key: API_KEY,
      singleEvents: "true",
      orderBy: "startTime",
      ...params
    });
    if(pageToken) q.set("pageToken", pageToken);
    url.search = q.toString();

    const res = await fetch(url.toString(), { cache: "no-store" });
    const data = await res.json();
    if(!res.ok){
      const m = data?.error?.message || `HTTP ${res.status}`;
      throw new Error(`Calendar API error: ${m}`);
    }
    if(Array.isArray(data.items)) items = items.concat(data.items);
    pageToken = data.nextPageToken || null;
  }while(pageToken);
  return items;
}

/* ====== Main ====== */
(async function main(){
  try{
    const nowISO = new Date().toISOString();

    // Past
    const pastAll = await fetchAll({ timeMax: nowISO, maxResults: 2500 });
    const pastWork = pastAll.filter(isWork).filter(ev => evStart(ev)&&evEnd(ev))
                            .sort((a,b)=> evStart(b)-evStart(a));

    // Totals
    const totalHrs = pastWork.reduce((acc,ev)=> acc + durHours(ev), 0);
    setText("totalHours", `${totalHrs.toFixed(2)} hrs`);
    setText("totalDays", `${(totalHrs/6).toFixed(2)} days @ 6 hrs/day`);

    // Past render
    const pastEl = document.getElementById("past");
    pastEl.innerHTML = pastWork.length ? "" : `<div class="empty">No past sessions found.</div>`;
    for(const ev of pastWork){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = line(ev);
      pastEl.appendChild(row);
    }

    // Future
    const futureAll = await fetchAll({ timeMin: nowISO, maxResults: 2500 });
    const futureWork = futureAll.filter(isWork).filter(ev => evStart(ev)&&evEnd(ev))
                                .sort((a,b)=> evStart(a)-evStart(b));

    // Next 3
    const nextEl = document.getElementById("next");
    nextEl.innerHTML = "";
    const next3 = futureWork.slice(0,3);
    if(next3.length===0){ nextEl.innerHTML = `<div class="empty">No upcoming sessions.</div>`; }
    else{
      for(const ev of next3){
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = line(ev);
        nextEl.appendChild(row);
      }
    }

    // Future toggle
    const toggleBtn = document.getElementById("toggleFuture");
    const futureCard = document.getElementById("futureCard");
    const futureList = document.getElementById("future");
    toggleBtn.disabled = futureWork.length===0;
    toggleBtn.onclick = ()=>{
      const show = futureCard.style.display==="none";
      futureCard.style.display = show ? "block" : "none";
      toggleBtn.textContent = show ? "Hide all future sessions" : "Show all future sessions";
      if(show){
        futureList.innerHTML = "";
        for(const ev of futureWork){
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = line(ev);
          futureList.appendChild(row);
        }
      }
    };

  }catch(err){
    console.error(err);
    setError(err.message || "Unknown error. Check API key, that Calendar API is enabled, and the calendar is public.");
    setText("totalHours","Error"); setText("totalDays","");
    document.getElementById("past").innerHTML = `<div class="empty">—</div>`;
    document.getElementById("next").innerHTML = `<div class="empty">—</div>`;
  }
})();
</script>
</body>
</html>
